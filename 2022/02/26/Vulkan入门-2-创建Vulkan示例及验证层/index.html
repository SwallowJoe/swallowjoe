<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"swallowjoe.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="参考资料 简述 一. 创建 vulkan 实例 1.1 创建 Window 实例 1.2 创建 Vulkan 实例   二. 验证层(Validation layers) 2.1 什么是 Validation layers？ 2.2 Validation layers示例 2.3 启用验证层 2.4 消息回调 2.4.1 调试回调函数 debugCallback 2.4.2 注册调试回调">
<meta property="og:type" content="article">
<meta property="og:title" content="Vulkan入门(2)-创建Vulkan示例及验证层">
<meta property="og:url" content="https://swallowjoe.github.io/2022/02/26/Vulkan%E5%85%A5%E9%97%A8-2-%E5%88%9B%E5%BB%BAVulkan%E7%A4%BA%E4%BE%8B%E5%8F%8A%E9%AA%8C%E8%AF%81%E5%B1%82/index.html">
<meta property="og:site_name" content="SwallowJoe的博客">
<meta property="og:description" content="参考资料 简述 一. 创建 vulkan 实例 1.1 创建 Window 实例 1.2 创建 Vulkan 实例   二. 验证层(Validation layers) 2.1 什么是 Validation layers？ 2.2 Validation layers示例 2.3 启用验证层 2.4 消息回调 2.4.1 调试回调函数 debugCallback 2.4.2 注册调试回调">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://swallowjoe.github.io/images/Vulkan%E5%85%A5%E9%97%A8-2-%E5%88%9B%E5%BB%BAVulkan%E7%A4%BA%E4%BE%8B%E5%8F%8A%E9%AA%8C%E8%AF%81%E5%B1%82/Vulkan_2_1.png">
<meta property="article:published_time" content="2022-02-26T14:24:59.000Z">
<meta property="article:modified_time" content="2022-02-26T14:36:43.896Z">
<meta property="article:author" content="SwallowJoe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://swallowjoe.github.io/images/Vulkan%E5%85%A5%E9%97%A8-2-%E5%88%9B%E5%BB%BAVulkan%E7%A4%BA%E4%BE%8B%E5%8F%8A%E9%AA%8C%E8%AF%81%E5%B1%82/Vulkan_2_1.png">

<link rel="canonical" href="https://swallowjoe.github.io/2022/02/26/Vulkan%E5%85%A5%E9%97%A8-2-%E5%88%9B%E5%BB%BAVulkan%E7%A4%BA%E4%BE%8B%E5%8F%8A%E9%AA%8C%E8%AF%81%E5%B1%82/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Vulkan入门(2)-创建Vulkan示例及验证层 | SwallowJoe的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">SwallowJoe的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Be a real go-getter,<br>NEVER SETTLE!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swallowjoe.github.io/2022/02/26/Vulkan%E5%85%A5%E9%97%A8-2-%E5%88%9B%E5%BB%BAVulkan%E7%A4%BA%E4%BE%8B%E5%8F%8A%E9%AA%8C%E8%AF%81%E5%B1%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="SwallowJoe">
      <meta itemprop="description" content="君子知命不惧，日日自新">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwallowJoe的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Vulkan入门(2)-创建Vulkan示例及验证层
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-02-26 22:24:59 / 修改时间：22:36:43" itemprop="dateCreated datePublished" datetime="2022-02-26T22:24:59+08:00">2022-02-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
<li><a href="#%E7%AE%80%E8%BF%B0">简述</a></li>
<li><a href="#%E4%B8%80-%E5%88%9B%E5%BB%BA-vulkan-%E5%AE%9E%E4%BE%8B">一. 创建 vulkan 实例</a><ul>
<li><a href="#11-%E5%88%9B%E5%BB%BA-window-%E5%AE%9E%E4%BE%8B">1.1 创建 Window 实例</a></li>
<li><a href="#12-%E5%88%9B%E5%BB%BA-vulkan-%E5%AE%9E%E4%BE%8B">1.2 创建 Vulkan 实例</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C-%E9%AA%8C%E8%AF%81%E5%B1%82validation-layers">二. 验证层(Validation layers)</a><ul>
<li><a href="#21-%E4%BB%80%E4%B9%88%E6%98%AF-validation-layers">2.1 什么是 Validation layers？</a></li>
<li><a href="#22-validation-layers%E7%A4%BA%E4%BE%8B">2.2 Validation layers示例</a></li>
<li><a href="#23-%E5%90%AF%E7%94%A8%E9%AA%8C%E8%AF%81%E5%B1%82">2.3 启用验证层</a></li>
<li><a href="#24-%E6%B6%88%E6%81%AF%E5%9B%9E%E8%B0%83">2.4 消息回调</a><ul>
<li><a href="#241-%E8%B0%83%E8%AF%95%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0-debugcallback">2.4.1 调试回调函数 debugCallback</a></li>
<li><a href="#242-%E6%B3%A8%E5%86%8C%E8%B0%83%E8%AF%95%E5%9B%9E%E8%B0%83">2.4.2 注册调试回调</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E4%B8%89-%E4%BB%A3%E7%A0%81">三. 代码</a><ul>
<li><a href="#31-makefile">3.1 Makefile</a></li>
<li><a href="#32-maincpp">3.2 main.cpp</a></li>
</ul>
</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/KhronosGroup/Vulkan-Docs">https://github.com/KhronosGroup/Vulkan-Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/html/vkspec.html#vkCreateInstance">https://www.khronos.org/registry/vulkan/specs/1.1-extensions/html/vkspec.html#vkCreateInstance</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/SaschaWillems/Vulkan/blob/master/base/vulkanexamplebase.h">https://github.com/SaschaWillems/Vulkan/blob/master/base/vulkanexamplebase.h</a></li>
</ol>
<h1 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h1><p>本文主要是实现Vulkan Tutorial.pdf文档中的Base Code, Instance和Validation Layers部分。</p>
<h1 id="一-创建-vulkan-实例"><a href="#一-创建-vulkan-实例" class="headerlink" title="一. 创建 vulkan 实例"></a>一. 创建 vulkan 实例</h1><h2 id="1-1-创建-Window-实例"><a href="#1-1-创建-Window-实例" class="headerlink" title="1.1 创建 Window 实例"></a>1.1 创建 Window 实例</h2><p>先创建个 window 窗口</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">initWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 第一步一定是先初始化GLFW库.</span></span><br><span class="line">    <span class="built_in">glfwInit</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为GLFW最初是为创建OpenGL上下文而设计的，</span></span><br><span class="line">    <span class="comment">// 所以我们需要告诉它不要通过后续调用创建OpenGL上下文：GLFW_NO_API</span></span><br><span class="line">    <span class="built_in">glfwWindowHint</span>(GLFW_CLIENT_API, GLFW_NO_API);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为处理大小可变的窗口比较复杂，暂时先让窗口不可变</span></span><br><span class="line">    <span class="built_in">glfwWindowHint</span>(GLFW_RESIZABLE, GLFW_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建窗口</span></span><br><span class="line">    <span class="comment">// GLFWwindow *glfwCreateWindow(int width, int height, const char *title, GLFWmonitor *monitor, GLFWwindow *share)</span></span><br><span class="line">    window = <span class="built_in">glfwCreateWindow</span>(WIDTH, HEIGHT, WINDOW_TITLE, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-创建-Vulkan-实例"><a href="#1-2-创建-Vulkan-实例" class="headerlink" title="1.2 创建 Vulkan 实例"></a>1.2 创建 Vulkan 实例</h2><ol>
<li>创建 VkApplicationInfo 结构体变量，参数可选</li>
<li>创建 VkInstanceCreateInfo 结构体变量，必须指明<ol>
<li>使用 GLFW (glfwGetRequiredInstanceExtensions) 创建 glfwExtensions, 以便为GLFW窗口创建Vulkan surface</li>
</ol>
</li>
<li>调用 vkCreateInstance, 创建 vulkan 实例</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">createInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个实例首先必须填写一个包含有关我们应用程序的信息的结构: VkApplicationInfo</span></span><br><span class="line">    <span class="comment">// 这些数据在技术上是可选的，但它可以为驱动程序提供一些有用的信息，以便针对我们的特定应用进行优化</span></span><br><span class="line">    VkApplicationInfo appInfo = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Vulkan中的许多结构要求在sType成员中明确指定类型。 </span></span><br><span class="line">    <span class="comment">// 这也是具有pNext成员的许多结构中的一个，该成员可以在将来指向扩展信息。</span></span><br><span class="line">    appInfo.sType = VK_STRUCTURE_TYPE_APPLICATION_INFO;</span><br><span class="line"></span><br><span class="line">    appInfo.pApplicationName = <span class="string">&quot;Hello Triangle&quot;</span>;</span><br><span class="line">    appInfo.applicationVersion = <span class="built_in">VK_MAKE_VERSION</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    appInfo.pEngineName = <span class="string">&quot;No Engine&quot;</span>;</span><br><span class="line">    appInfo.engineVersion = <span class="built_in">VK_MAKE_VERSION</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    appInfo.apiVersion = VK_API_VERSION_1_1;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Vulkan中的很多信息都是通过结构而不是函数参数传递的，</span></span><br><span class="line">    <span class="comment">// 我们必须再填充一个结构体 VkInstanceCreateInfo 来为创建实例提供足够的信息。</span></span><br><span class="line">    <span class="comment">// VkInstanceCreateInfo结构是必须指明的，它告诉Vulkan驱动程序我们想要使用哪些全局扩展和验证层。 </span></span><br><span class="line">    VkInstanceCreateInfo createInfo = &#123;&#125;;</span><br><span class="line">    createInfo.sType = VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO;</span><br><span class="line">    createInfo.pNext = <span class="literal">nullptr</span>;</span><br><span class="line">    createInfo.pApplicationInfo = &amp;appInfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前两个参数很简单。 </span></span><br><span class="line">    <span class="comment">// Vulkan是一个与平台无关的API，这意味着需要一个与窗口系统接口的扩展。</span></span><br><span class="line">    <span class="comment">// GLFW有一个方便的内置函数，它返回它需要做的扩展，我们可以传递给结构体：VkInstanceCreateInfo</span></span><br><span class="line">    <span class="type">uint32_t</span> glfwExtensionCount = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>** glfwExtensions;</span><br><span class="line">    <span class="comment">// 返回GLFW所需的Vulkan实例扩展。</span></span><br><span class="line">    <span class="comment">// 此函数返回GLFW所需的Vulkan实例扩展名的数组，以便为GLFW窗口创建Vulkan surface。 </span></span><br><span class="line">    <span class="comment">// 如果成功，列表将始终包含`VK_KHR_surface`，因此如果您不需要任何其他扩展，则可以将此列表直接传递给`VkInstanceCreateInfo`结构。</span></span><br><span class="line">    <span class="comment">// 如果机器上没有Vulkan，则此函数返回“NULL”并生成 GLFW_API_UNAVAILABLE错误。</span></span><br><span class="line">    glfwExtensions = <span class="built_in">glfwGetRequiredInstanceExtensions</span>(&amp;glfwExtensionCount);</span><br><span class="line"></span><br><span class="line">    createInfo.enabledExtensionCount = glfwExtensionCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// createInfo.ppEnabledLayerNames = glfwExtensions;</span></span><br><span class="line">    <span class="comment">// 笔者曾在这里栽了个跟头，写错了。如上写，编译不出问题，但运行时会报 Segmentation fault (core dumped)</span></span><br><span class="line">    <span class="comment">// 打印堆栈，看了半天，才发现的，引以为戒，不过这两变量名字很像。</span></span><br><span class="line">    createInfo.ppEnabledExtensionNames = glfwExtensions;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结构体的最后两个成员确定要启用的全局验证层。</span></span><br><span class="line">    createInfo.enabledLayerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// VkResult vkCreateInstance(const VkInstanceCreateInfo *pCreateInfo, const VkAllocationCallbacks *pAllocator, VkInstance *pInstance)</span></span><br><span class="line">    VkResult res = <span class="built_in">vkCreateInstance</span>(&amp;createInfo, <span class="literal">nullptr</span>, &amp;instance);</span><br><span class="line">    <span class="keyword">if</span> (res != VK_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to create instance!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二-验证层-Validation-layers"><a href="#二-验证层-Validation-layers" class="headerlink" title="二. 验证层(Validation layers)"></a>二. 验证层(Validation layers)</h1><h2 id="2-1-什么是-Validation-layers？"><a href="#2-1-什么是-Validation-layers？" class="headerlink" title="2.1 什么是 Validation layers？"></a>2.1 什么是 Validation layers？</h2><p>Vulkan API围绕最小驱动程序开销的想法而设计，该目标的一个表现形式是默认情况下API中的错误检查非常有限。<br>即使是将枚举设置为不正确的值或将空指针传递给所需参数这样简单的错误通常也不会被显式处理，只会导致崩溃或未定义的行为。<br>这一点，笔者已经深刻体会到了，(╯﹏╰)<br>因为Vulkan要求你对你所做的一切都非常明确，所以很容易犯很多小错误，例如使用新的GPU功能而忘记在逻辑设备创建时请求它。</p>
<p>但是，这并不意味着无法将这些检查添加到API中。<br>Vulkan为这种称为验证层的系统引入了一个优雅的系统: Validation layers.<br>验证层是可选组件，它挂接到Vulkan函数调用以应用其他操作。 </p>
<p>验证层中的常见操作是：</p>
<ol>
<li>根据规范检查参数值以检测误用</li>
<li>跟踪对象的创建和销毁以查找资源泄漏</li>
<li>通过跟踪调用的线程来检查线程安全性</li>
<li>将每个调用及其参数记录到标准输出方便调试</li>
<li>跟踪Vulkan要求进行性能分析和重放</li>
</ol>
<h2 id="2-2-Validation-layers示例"><a href="#2-2-Validation-layers示例" class="headerlink" title="2.2 Validation layers示例"></a>2.2 Validation layers示例</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VkResult <span class="title">vkCreateInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VkInstanceCreateInfo* pCreateInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VkAllocationCallbacks* pAllocator,</span></span></span><br><span class="line"><span class="params"><span class="function">    VkInstance* instance)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pCreateInfo == <span class="literal">nullptr</span> || instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;Null pointer passed to required parameter!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> VK_ERROR_INITIALIZATION_FAILED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">real_vkCreateInstance</span>(pCreateInfo, pAllocator, instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如上面的vkCreateInstance中的if语句。官方文档上如此说：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">这些验证层可以自由堆叠，以包含您感兴趣的所有调试功能。</span><br><span class="line">您可以简单地为调试版本启用验证层，并为发布版本完全禁用它们，这将为您提供两全其美的优势！</span><br><span class="line">Vulkan没有内置任何验证层，但LunarG Vulkan SDK提供了一组很好的层来检查常见错误。</span><br><span class="line">它们也是完全开源的，因此您可以检查它们检查和贡献的错误类型。</span><br><span class="line">使用验证层是避免应用程序因意外依赖未定义行为而破坏不同驱动程序的最佳方法。</span><br><span class="line">验证层只有在已安装到系统上时才能使用。</span><br><span class="line">例如，LunarG验证层仅适用于安装了Vulkan SDK的PC。</span><br><span class="line">Vulkan中以前有两种不同类型的验证层：实例和设备特定。</span><br><span class="line">我们的想法是，实例层只会检查与全局Vulkan对象（如实例）相关的调用，而设备特定层只会检查与特定GPU相关的调用。</span><br><span class="line">现在已弃用特定于设备的层，这意味着实例验证层适用于所有Vulkan调用。</span><br><span class="line">规范文档仍建议您在设备级别启用验证层以及兼容性，这是某些实现所需的。</span><br></pre></td></tr></table></figure>

<h2 id="2-3-启用验证层"><a href="#2-3-启用验证层" class="headerlink" title="2.3 启用验证层"></a>2.3 启用验证层</h2><p>如何启用Vulkan SDK提供的标准诊断层? 就像扩展一样，需要通过指定其名称来启用验证层。<br>所有有用的标准验证都捆绑在SDK中包含的层中，称为VK_LAYER_KHRONOS_validation。<br>让我们首先向程序添加两个配置变量，以指定要启用的层以及是否启用它们。 我已经选择将该值作为程序是否在调试模式下编译。<br>NDEBUG宏是C ++标准的一部分，意味着“不调试”。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> std::vector&lt;<span class="type">const</span> <span class="type">char</span>*&gt; validationLayers = &#123;</span><br><span class="line">    <span class="string">&quot;VK_LAYER_KHRONOS_validation&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NDEBUG</span></span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> enableValidationLayers = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> enableValidationLayers = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2 id="2-4-消息回调"><a href="#2-4-消息回调" class="headerlink" title="2.4 消息回调"></a>2.4 消息回调</h2><p>仅启用这些层并没有多大帮助，因为它们目前无法将调试消息中继回我们的程序。<br>要接收这些消息，我们必须设置一个带回调的调试信使，这需要VK_EXT_debug_utils扩展。<br>我们将首先创建一个getRequiredExtensions函数，根据是否启用验证层返回所需的扩展名列表：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::vector&lt;<span class="type">const</span> <span class="type">char</span>*&gt; <span class="title">getRequiredExtensions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> glfwExtensionCount = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>** glfwExtensions;</span><br><span class="line">    glfwExtensions = <span class="built_in">glfwGetRequiredInstanceExtensions</span>(&amp;glfwExtensionCount);</span><br><span class="line"></span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">const</span> <span class="type">char</span>*&gt; <span class="title">extensions</span><span class="params">(glfwExtensions, glfwExtensions + glfwExtensionCount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableValidationLayers) &#123;</span><br><span class="line">        extensions.<span class="built_in">push_back</span>(VK_EXT_DEBUG_UTILS_EXTENSION_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> extensions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GLFW指定的扩展始终是必需的，但有条件地添加了调试信使扩展(VK_EXT_debug_utils)。<br>请注意，在这里使用了VK_EXT_DEBUG_UTILS_EXTENSION_NAME宏，它等于文字字符串“VK_EXT_debug_utils”。 使用此宏可以避免拼写错误。<br>我们现在可以在createInstance中使用此函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> extensions = <span class="built_in">getRequiredExtensions</span>();</span><br><span class="line">createInfo.enabledExtensionCount = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(extensions.<span class="built_in">size</span>());</span><br><span class="line">createInfo.ppEnabledExtensionNames = extensions.<span class="built_in">data</span>();</span><br></pre></td></tr></table></figure>

<h3 id="2-4-1-调试回调函数-debugCallback"><a href="#2-4-1-调试回调函数-debugCallback" class="headerlink" title="2.4.1 调试回调函数 debugCallback"></a>2.4.1 调试回调函数 debugCallback</h3><p>现在让我们看一下调试回调函数的样子。<br>使用PFN_vkDebugUtilsMessengerCallbackEXT原型添加一个名为debugCallback的新静态成员函数。<br>VKAPI_ATTR和VKAPI_CALL确保该函数具有Vulkan调用它的正确签名。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> VKAPI_ATTR VkBool32 VKAPI_CALL <span class="title">debugCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VkDebugUtilsMessageSeverityFlagBitsEXT messageSeverity,</span></span></span><br><span class="line"><span class="params"><span class="function">    VkDebugUtilsMessageTypeFlagsEXT messageType,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> VkDebugUtilsMessengerCallbackDataEXT* pCallbackData,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span>* pUserData)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;validation layer: &quot;</span> &lt;&lt; pCallbackData-&gt;pMessage&lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> VK_FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>第一个参数: VkDebugUtilsMessageSeverityFlagBitsEXT 指明了消息的严重程度<br>•VK_DEBUG_UTILS_MESSAGE_SEVERITY_VERBOSE_BIT_EXT：诊断消息<br>•VK_DEBUG_UTILS_MESSAGE_SEVERITY_INFO_BIT_EXT：信息性消息，如创建资源<br>•VK_DEBUG_UTILS_MESSAGE_SEVERITY_WARNING_BIT_EXT：有关行为的消息不一定是错误，但很可能是应用程序中的错误<br>•VK_DEBUG_UTILS_MESSAGE_SEVERITY_ERROR_BIT_EXT：有关无效行为的消息，可能导致崩溃<br>可以根据这个参数过滤所需的信息。</li>
<li>第二个参数: VkDebugUtilsMessageTypeFlagsEXT 指明了消息的类型<br>•VK_DEBUG_UTILS_MESSAGE_TYPE_GENERAL_BIT_EXT：发生了与规范或性能无关的某些事件<br>•VK_DEBUG_UTILS_MESSAGE_TYPE_VALIDATION_BIT_EXT：发生了违反规范或表明可能存在错误的事情<br>•VK_DEBUG_UTILS_MESSAGE_TYPE_PERFORMANCE_BIT_EXT：潜在的非最佳使用Vulkan</li>
<li>第三个参数: VkDebugUtilsMessengerCallbackDataEXT 这个结构体包含了消息更多的细节内容<br>•pMessage：调试消息为以空字符结尾的字符串<br>•pObjects：与消息相关的Vulkan对象句柄数组<br>•object Count：数组中的对象数</li>
<li>第四个参数: pUserData 包含在回调设置期间指定的指针，并允许您将自己的数据传递给它。</li>
</ol>
<p>回调返回一个布尔值，指示是否应该中止触发验证层消息的Vulkan调用。<br>如果回调返回true，则调用将因VK_ERROR_VALIDATION_FAILED_EXT错误而中止。<br>这通常仅用于测试验证层本身，因此应始终返回VK_FALSE。</p>
<h3 id="2-4-2-注册调试回调"><a href="#2-4-2-注册调试回调" class="headerlink" title="2.4.2 注册调试回调"></a>2.4.2 注册调试回调</h3><p>在Vulkan中, 调试回调也是通过需要显式创建和销毁的句柄来管理的。 这样的回调是debug message的一部分，可以根据需要设置尽可能多的回调。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在成员变量中添加：VkDebugUtilsMessengerEXT</span></span><br><span class="line">VkDebugUtilsMessengerEXT debugMessenger;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initVulkan</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">createInstance</span>();</span><br><span class="line">    <span class="built_in">setupDebugMessenger</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setupDebugMessenger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!enableValidationLayers) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    VkDebugUtilsMessengerCreateInfoEXT createInfo = &#123;&#125;;</span><br><span class="line">    createInfo.sType = VK_STRUCTURE_TYPE_DEBUG_UTILS_MESSENGER_CREATE_INFO_EXT;</span><br><span class="line">    createInfo.messageSeverity =</span><br><span class="line">        VK_DEBUG_UTILS_MESSAGE_SEVERITY_VERBOSE_BIT_EXT |</span><br><span class="line">        VK_DEBUG_UTILS_MESSAGE_SEVERITY_WARNING_BIT_EXT |</span><br><span class="line">        VK_DEBUG_UTILS_MESSAGE_SEVERITY_ERROR_BIT_EXT;</span><br><span class="line">    createInfo.messageType =</span><br><span class="line">        VK_DEBUG_UTILS_MESSAGE_TYPE_GENERAL_BIT_EXT |</span><br><span class="line">        VK_DEBUG_UTILS_MESSAGE_TYPE_VALIDATION_BIT_EXT |</span><br><span class="line">        VK_DEBUG_UTILS_MESSAGE_TYPE_PERFORMANCE_BIT_EXT;</span><br><span class="line">    <span class="comment">// 指定消息回调函数</span></span><br><span class="line">    createInfo.pfnUserCallback = debugCallback;</span><br><span class="line">    createInfo.pUserData = <span class="literal">nullptr</span>; <span class="comment">// 可选</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>messageSeverity字段允许指定要为其调用回调的所有类型的严重性。<br>在这里指定了除VK_DEBUG_UTILS_MESSAGE_SEVERITY_INFO_BIT_EXT之外的所有类型，以接收有关可能问题的通知，同时省略详细的一般调试信息。<br>类似地，messageType字段可以过滤通知回调的消息类型。 在这里启用了所有类型。<br>最后，pfnUserCallback字段指定回调函数的指针。可以选择将指针传递给pUserData字段，该字段将通过pUserData参数传递给回调函数。<br>例如，可以使用它来传递指向HelloTriangleApplication类的指针。</p>
<p>应该将结构体 VkDebugUtilsMessengerEXT 传递给vkCreateDebugUtilsMessengerEXT函数以创建VkDebugUtilsMessengerEXT对象。<br>然而因为这个function是一个扩展函数，它不会自动加载。<br>必须使用vkGetInstanceProcAddr查找其地址。 创建代理函数，然后在处理它，如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VkResult <span class="title">CreateDebugUtilsMessengerEXT</span><span class="params">(VkInstance instance, <span class="type">const</span></span></span></span><br><span class="line"><span class="params"><span class="function">    VkDebugUtilsMessengerCreateInfoEXT* pCreateInfo, <span class="type">const</span></span></span></span><br><span class="line"><span class="params"><span class="function">    VkAllocationCallbacks* pAllocator, VkDebugUtilsMessengerEXT*</span></span></span><br><span class="line"><span class="params"><span class="function">    pDebugMessenger)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> func = (PFN_vkCreateDebugUtilsMessengerEXT)</span><br><span class="line">    <span class="built_in">vkGetInstanceProcAddr</span>(instance,<span class="string">&quot;vkCreateDebugUtilsMessengerEXT&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (func != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">func</span>(instance, pCreateInfo, pAllocator, pDebugMessenger);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> VK_ERROR_EXTENSION_NOT_PRESENT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们可以在 setupDebugMessenger 中调用此函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setupDebugMessenger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!enableValidationLayers) <span class="keyword">return</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// 实例化DebugUtilsMessengerEXT</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">CreateDebugUtilsMessengerEXT</span>(instance, &amp;createInfo, <span class="literal">nullptr</span>,</span><br><span class="line">        &amp;debugMessenger) != VK_SUCCESS) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to set up debug messenger!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后注意，既然有 vkCreateXXX, 就需要显示调用 vkDestroyXXX 哦！</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DestroyDebugUtilsMessengerEXT</span><span class="params">(VkInstance instance,</span></span></span><br><span class="line"><span class="params"><span class="function">    VkDebugUtilsMessengerEXT debugMessenger, <span class="type">const</span></span></span></span><br><span class="line"><span class="params"><span class="function">    VkAllocationCallbacks* pAllocator)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> func = (PFN_vkDestroyDebugUtilsMessengerEXT)</span><br><span class="line">    <span class="built_in">vkGetInstanceProcAddr</span>(instance, <span class="string">&quot;vkDestroyDebugUtilsMessengerEXT&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (func != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">func</span>(instance, debugMessenger, pAllocator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你忘了调用DestroyDebugUtilsMessengerEXT去销毁debugMessenger，在关闭窗口的时候就会打印如下信息:</p>
<p><img src="/images/Vulkan%E5%85%A5%E9%97%A8-2-%E5%88%9B%E5%BB%BAVulkan%E7%A4%BA%E4%BE%8B%E5%8F%8A%E9%AA%8C%E8%AF%81%E5%B1%82/Vulkan_2_1.png" alt="图片"></p>
<h1 id="三-代码"><a href="#三-代码" class="headerlink" title="三. 代码"></a>三. 代码</h1><h2 id="3-1-Makefile"><a href="#3-1-Makefile" class="headerlink" title="3.1 Makefile"></a>3.1 Makefile</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">VULKAN_SDK_PATH = /home/jh/Program/vulkan/1.1.160.0/x86_64</span><br><span class="line"></span><br><span class="line">CFLAGS = -std=c++17 -I<span class="variable">$(VULKAN_SDK_PATH)</span>/<span class="keyword">include</span></span><br><span class="line">LDFLAGS = -L<span class="variable">$(VULKAN_SDK_PATH)</span>/lib -lvulkan `pkg-config --static --libs glfw3`</span><br><span class="line">LDFLAGS += -ldl</span><br><span class="line"></span><br><span class="line"><span class="section">HelloTriangleApplication: main.cpp</span></span><br><span class="line">	g++ <span class="variable">$(CFLAGS)</span> -o HelloTriangleApplication main.cpp <span class="variable">$(LDFLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: test clean</span></span><br><span class="line"></span><br><span class="line"><span class="section">test: HelloTriangleApplication</span></span><br><span class="line">    LD_LIBRARY_PATH=<span class="variable">$(VULKAN_SDK_PATH)</span>/lib</span><br><span class="line">        VK_LAYER_PATH=<span class="variable">$(VULKAN_SDK_PATH)</span>/etc/explicit_layer.d ./HelloTriangleApplication</span><br><span class="line"></span><br><span class="line"><span class="section">clean:rm -f HelloTriangleApplication</span></span><br></pre></td></tr></table></figure>

<h2 id="3-2-main-cpp"><a href="#3-2-main-cpp" class="headerlink" title="3.2 main.cpp"></a>3.2 main.cpp</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * #include &lt;vulkan/vulkan.h&gt; // vulkan 头文件</span></span><br><span class="line"><span class="comment"> * 使用下面两行替换 vulkan头文件</span></span><br><span class="line"><span class="comment"> *   #define GLFW_INCLUDE_VULKAN</span></span><br><span class="line"><span class="comment"> *   #include &lt;GLFW/glfw3.h&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *  GLFW 会自动加载 vulkan 头文件的。</span></span><br><span class="line"><span class="comment"> * GLFW是一个开源，多平台的库，用于桌面上的OpenGL，OpenGL ES和Vulkan开发。 </span></span><br><span class="line"><span class="comment"> * 它提供了一个简单的API，用于创建窗口，上下文和曲面，接收输入和事件。</span></span><br><span class="line"><span class="comment"> * GLFW是用C语言编写的，并且使用X Window系统（例如Linux和FreeBSD）对Windows，macOS和许多类Unix系统提供原生支持。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLFW_INCLUDE_VULKAN</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;GLFW/glfw3.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span> <span class="comment">// 包含用于报告错误的头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span> <span class="comment">// 用于资源管理部分中的lambda函数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span> <span class="comment">// cstdlib: EXIT_FAILURE, EXIT_SUCCESS</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NDEBUG</span></span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> enableValidationLayers = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> enableValidationLayers = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelloTriangleApplication</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">initWindow</span>();</span><br><span class="line">        <span class="built_in">initVulkan</span>();</span><br><span class="line">        <span class="built_in">mainLoop</span>();</span><br><span class="line">        <span class="built_in">cleanup</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> WIDTH = <span class="number">800</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> HEIGHT = <span class="number">600</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * WINDOW_TITLE = <span class="string">&quot;Vulkan&quot;</span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">initWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 第一步一定是先初始化GLFW库.</span></span><br><span class="line">        <span class="built_in">glfwInit</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 因为GLFW最初是为创建OpenGL上下文而设计的，</span></span><br><span class="line">        <span class="comment">// 所以我们需要告诉它不要通过后续调用创建OpenGL上下文：GLFW_NO_API</span></span><br><span class="line">        <span class="built_in">glfwWindowHint</span>(GLFW_CLIENT_API, GLFW_NO_API);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 因为处理大小可变的窗口比较复杂，暂时先让窗口不可变</span></span><br><span class="line">        <span class="built_in">glfwWindowHint</span>(GLFW_RESIZABLE, GLFW_FALSE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建窗口</span></span><br><span class="line">        <span class="comment">// GLFWwindow *glfwCreateWindow(int width, int height, const char *title, GLFWmonitor *monitor, GLFWwindow *share)</span></span><br><span class="line">        window = <span class="built_in">glfwCreateWindow</span>(WIDTH, HEIGHT, WINDOW_TITLE, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">initVulkan</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">checkAvailableExtensions</span>();</span><br><span class="line">        <span class="built_in">createInstance</span>();</span><br><span class="line">        <span class="comment">// 创建DEBUG消息回调</span></span><br><span class="line">        <span class="built_in">setupDebugMessenger</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setupDebugMessenger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!enableValidationLayers) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        VkDebugUtilsMessengerCreateInfoEXT createInfo = &#123;&#125;;</span><br><span class="line">        createInfo.sType = VK_STRUCTURE_TYPE_DEBUG_UTILS_MESSENGER_CREATE_INFO_EXT;</span><br><span class="line">        createInfo.messageSeverity =</span><br><span class="line">            VK_DEBUG_UTILS_MESSAGE_SEVERITY_VERBOSE_BIT_EXT |</span><br><span class="line">            VK_DEBUG_UTILS_MESSAGE_SEVERITY_WARNING_BIT_EXT |</span><br><span class="line">            VK_DEBUG_UTILS_MESSAGE_SEVERITY_ERROR_BIT_EXT;</span><br><span class="line">        createInfo.messageType =</span><br><span class="line">            VK_DEBUG_UTILS_MESSAGE_TYPE_GENERAL_BIT_EXT |</span><br><span class="line">            VK_DEBUG_UTILS_MESSAGE_TYPE_VALIDATION_BIT_EXT |</span><br><span class="line">            VK_DEBUG_UTILS_MESSAGE_TYPE_PERFORMANCE_BIT_EXT;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 指定消息回调函数</span></span><br><span class="line">        createInfo.pfnUserCallback = debugCallback;</span><br><span class="line">        createInfo.pUserData = <span class="literal">nullptr</span>; <span class="comment">// 可选</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化DebugUtilsMessengerEXT</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">CreateDebugUtilsMessengerEXT</span>(instance, &amp;createInfo, <span class="literal">nullptr</span>,</span><br><span class="line">                &amp;debugMessenger) != VK_SUCCESS) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to set up debug messenger!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">checkAvailableExtensions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">uint32_t</span> extensionCount = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">vkEnumerateInstanceExtensionProperties</span>(<span class="literal">nullptr</span>, &amp;extensionCount, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="function">std::vector&lt;VkExtensionProperties&gt; <span class="title">extensions</span><span class="params">(extensionCount)</span></span>;</span><br><span class="line">        <span class="built_in">vkEnumerateInstanceExtensionProperties</span>(<span class="literal">nullptr</span>, &amp;extensionCount, extensions.<span class="built_in">data</span>());</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;available extensions:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; extension : extensions) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; extension.extensionName &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">checkValidationLayerSupport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">uint32_t</span> layerCount;</span><br><span class="line">        <span class="built_in">vkEnumerateInstanceLayerProperties</span>(&amp;layerCount, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function">std::vector&lt;VkLayerProperties&gt; <span class="title">availableLayers</span><span class="params">(layerCount)</span></span>;</span><br><span class="line">        <span class="built_in">vkEnumerateInstanceLayerProperties</span>(&amp;layerCount, availableLayers.<span class="built_in">data</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="type">char</span>* layerName : validationLayers) &#123;</span><br><span class="line">            <span class="comment">//bool layerFound = false;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; layerProperties : availableLayers) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(layerName, layerProperties.layerName) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//layerFound = true;</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">createInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 验证层，检验VK_LAYER_KHRONOS_validation</span></span><br><span class="line">        <span class="keyword">if</span> (enableValidationLayers &amp;&amp; !<span class="built_in">checkValidationLayerSupport</span>()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;validation layers requested, but not available!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个实例首先必须填写一个包含有关我们应用程序的信息的结构: VkApplicationInfo</span></span><br><span class="line">        <span class="comment">// 这些数据在技术上是可选的，但它可以为驱动程序提供一些有用的信息，以便针对我们的特定应用进行优化</span></span><br><span class="line">        VkApplicationInfo appInfo = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Vulkan中的许多结构要求在sType成员中明确指定类型。 </span></span><br><span class="line">        <span class="comment">// 这也是具有pNext成员的许多结构中的一个，该成员可以在将来指向扩展信息。</span></span><br><span class="line">        appInfo.sType = VK_STRUCTURE_TYPE_APPLICATION_INFO;</span><br><span class="line"></span><br><span class="line">        appInfo.pApplicationName = <span class="string">&quot;Hello Triangle&quot;</span>;</span><br><span class="line">        appInfo.applicationVersion = <span class="built_in">VK_MAKE_VERSION</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        appInfo.pEngineName = <span class="string">&quot;No Engine&quot;</span>;</span><br><span class="line">        appInfo.engineVersion = <span class="built_in">VK_MAKE_VERSION</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        appInfo.apiVersion = VK_API_VERSION_1_1;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Vulkan中的很多信息都是通过结构而不是函数参数传递的，</span></span><br><span class="line">        <span class="comment">// 我们必须再填充一个结构体 VkInstanceCreateInfo 来为创建实例提供足够的信息。</span></span><br><span class="line">        <span class="comment">// VkInstanceCreateInfo结构是必须指明的，它告诉Vulkan驱动程序我们想要使用哪些全局扩展和验证层。 </span></span><br><span class="line">        VkInstanceCreateInfo createInfo = &#123;&#125;;</span><br><span class="line">        createInfo.sType = VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO;</span><br><span class="line">        createInfo.pNext = <span class="literal">nullptr</span>;</span><br><span class="line">        createInfo.pApplicationInfo = &amp;appInfo;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        // 前两个参数很简单。 </span></span><br><span class="line"><span class="comment">        // Vulkan是一个与平台无关的API，这意味着需要一个与窗口系统接口的扩展。</span></span><br><span class="line"><span class="comment">        // GLFW有一个方便的内置函数，它返回它需要做的扩展，我们可以传递给结构体：VkInstanceCreateInfo</span></span><br><span class="line"><span class="comment">        uint32_t glfwExtensionCount = 0;</span></span><br><span class="line"><span class="comment">        const char** glfwExtensions;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">        // 返回GLFW所需的Vulkan实例扩展。</span></span><br><span class="line"><span class="comment">        // 此函数返回GLFW所需的Vulkan实例扩展名的数组，以便为GLFW窗口创建Vulkan surface。 </span></span><br><span class="line"><span class="comment">        // 如果成功，列表将始终包含`VK_KHR_surface`，因此如果您不需要任何其他扩展，则可以将此列表直接传递给`VkInstanceCreateInfo`结构。</span></span><br><span class="line"><span class="comment">        // 如果机器上没有Vulkan，则此函数返回“NULL”并生成 GLFW_API_UNAVAILABLE错误。</span></span><br><span class="line"><span class="comment">        glfwExtensions = glfwGetRequiredInstanceExtensions(&amp;glfwExtensionCount);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 笔者曾在这里栽了个跟头，写错了。如上写，编译不出问题，但运行时会报 Segmentation fault (core dumped)</span></span><br><span class="line"><span class="comment">        // 打印堆栈，看了半天，才发现的，引以为戒，不过这两变量名字很像。</span></span><br><span class="line"><span class="comment">        createInfo.ppEnabledLayerNames = glfwExtensions;</span></span><br><span class="line"><span class="comment">        createInfo.ppEnabledExtensionNames = glfwExtensions;</span></span><br><span class="line"><span class="comment">        createInfo.enabledExtensionCount = glfwExtensionCount;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">// 返回GLFW所需的Vulkan实例扩展, 支持消息回调</span></span><br><span class="line">        <span class="keyword">auto</span> extensions = <span class="built_in">getRequiredExtensions</span>();</span><br><span class="line">        createInfo.enabledExtensionCount = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(extensions.<span class="built_in">size</span>());</span><br><span class="line">        createInfo.ppEnabledExtensionNames = extensions.<span class="built_in">data</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 结构体的最后两个成员确定要启用的全局验证层。</span></span><br><span class="line">        <span class="keyword">if</span> (enableValidationLayers) &#123;</span><br><span class="line">            createInfo.enabledLayerCount = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(validationLayers.<span class="built_in">size</span>());</span><br><span class="line">            createInfo.ppEnabledLayerNames = validationLayers.<span class="built_in">data</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            createInfo.enabledLayerCount = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// VkResult vkCreateInstance(const VkInstanceCreateInfo *pCreateInfo, const VkAllocationCallbacks *pAllocator, VkInstance *pInstance)</span></span><br><span class="line">        VkResult res = <span class="built_in">vkCreateInstance</span>(&amp;createInfo, <span class="literal">nullptr</span>, &amp;instance);</span><br><span class="line">        <span class="keyword">if</span> (res != VK_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;failed to create instance!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">mainLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 添加一个事件循环, 使应用程序保持运行直到发生错误或窗口关闭</span></span><br><span class="line">        <span class="keyword">while</span> (!<span class="built_in">glfwWindowShouldClose</span>(window)) &#123;</span><br><span class="line">            <span class="built_in">glfwPollEvents</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 vulkan 中推荐在创建的资源不需要后主动释放</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 释放debugMessenger(VkDebugUtilsMessengerEXT, 用于打印调试信息)</span></span><br><span class="line">        <span class="keyword">if</span> (enableValidationLayers) &#123;</span><br><span class="line">            <span class="built_in">DestroyDebugUtilsMessengerEXT</span>(instance, debugMessenger, <span class="literal">nullptr</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 在 vulkan 中资源一般都是 vkCreateXXX 创建，由 vkDestroyXXX 或 vkFreeXXX 释放.</span></span><br><span class="line">        <span class="built_in">vkDestroyInstance</span>(instance, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 此函数会破坏指定的窗口及其上下文。 在调用此函数时，不会为该窗口调用其他回调。</span></span><br><span class="line">        <span class="comment">// 如果指定窗口的上下文在主线程上是最新的，则在销毁之前将其分离。</span></span><br><span class="line">        <span class="built_in">glfwDestroyWindow</span>(window);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 此功能会释放所有剩余的窗口和光标并释放任何其他已分配的资源。 </span></span><br><span class="line">        <span class="comment">// 调用此函数后，必须再次成功调用@ref glfwInit，然后才能使用大多数GLFW函数。</span></span><br><span class="line">        <span class="built_in">glfwTerminate</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于消息回调Message Callback</span></span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">const</span> <span class="type">char</span>*&gt; <span class="title">getRequiredExtensions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">uint32_t</span> glfwExtensionCount = <span class="number">0</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>** glfwExtensions;</span><br><span class="line">        glfwExtensions = <span class="built_in">glfwGetRequiredInstanceExtensions</span>(&amp;glfwExtensionCount);</span><br><span class="line"></span><br><span class="line">        <span class="function">std::vector&lt;<span class="type">const</span> <span class="type">char</span>*&gt; <span class="title">extensions</span><span class="params">(glfwExtensions, glfwExtensions + glfwExtensionCount)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enableValidationLayers) &#123;</span><br><span class="line">            extensions.<span class="built_in">push_back</span>(VK_EXT_DEBUG_UTILS_EXTENSION_NAME);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> extensions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印debug信息</span></span><br><span class="line">    <span class="function"><span class="type">static</span> VKAPI_ATTR VkBool32 VKAPI_CALL <span class="title">debugCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        VkDebugUtilsMessageSeverityFlagBitsEXT messageSeverity,</span></span></span><br><span class="line"><span class="params"><span class="function">        VkDebugUtilsMessageTypeFlagsEXT messageType,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> VkDebugUtilsMessengerCallbackDataEXT* pCallbackData,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">void</span>* pUserData)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;validation layer: &quot;</span> &lt;&lt; pCallbackData-&gt;pMessage&lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> VK_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 VkDebugUtilsMessengerEXT 对象debugMessenger</span></span><br><span class="line">    <span class="function">VkResult <span class="title">CreateDebugUtilsMessengerEXT</span><span class="params">(VkInstance instance, <span class="type">const</span></span></span></span><br><span class="line"><span class="params"><span class="function">        VkDebugUtilsMessengerCreateInfoEXT* pCreateInfo, <span class="type">const</span></span></span></span><br><span class="line"><span class="params"><span class="function">        VkAllocationCallbacks* pAllocator, VkDebugUtilsMessengerEXT*</span></span></span><br><span class="line"><span class="params"><span class="function">        pDebugMessenger)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将结构体 VkDebugUtilsMessengerEXT 传递给vkCreateDebugUtilsMessengerEXT函数以创建VkDebugUtilsMessengerEXT对象。 </span></span><br><span class="line">        <span class="comment">// 然而因为这个function是一个扩展函数，它不会自动加载。</span></span><br><span class="line">        <span class="comment">// 必须使用vkGetInstanceProcAddr查找其地址。</span></span><br><span class="line">        <span class="keyword">auto</span> func = (PFN_vkCreateDebugUtilsMessengerEXT)</span><br><span class="line">        <span class="built_in">vkGetInstanceProcAddr</span>(instance,<span class="string">&quot;vkCreateDebugUtilsMessengerEXT&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (func != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">func</span>(instance, pCreateInfo, pAllocator, pDebugMessenger);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> VK_ERROR_EXTENSION_NOT_PRESENT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁VkDebugUtilsMessengerEXT</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">DestroyDebugUtilsMessengerEXT</span><span class="params">(VkInstance instance,</span></span></span><br><span class="line"><span class="params"><span class="function">        VkDebugUtilsMessengerEXT debugMessenger, <span class="type">const</span></span></span></span><br><span class="line"><span class="params"><span class="function">        VkAllocationCallbacks* pAllocator)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> func = (PFN_vkDestroyDebugUtilsMessengerEXT)</span><br><span class="line">        <span class="built_in">vkGetInstanceProcAddr</span>(instance, <span class="string">&quot;vkDestroyDebugUtilsMessengerEXT&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (func != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="built_in">func</span>(instance, debugMessenger, pAllocator);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Window实例</span></span><br><span class="line">    GLFWwindow* window;</span><br><span class="line">    <span class="comment">// Vulkan实例</span></span><br><span class="line">    VkInstance instance;</span><br><span class="line">    <span class="comment">// DEBUG消息回调</span></span><br><span class="line">    VkDebugUtilsMessengerEXT debugMessenger;</span><br><span class="line">    <span class="comment">// 验证层</span></span><br><span class="line">    <span class="type">const</span> std::vector&lt;<span class="type">const</span> <span class="type">char</span>*&gt; validationLayers = &#123;</span><br><span class="line">        <span class="string">&quot;VK_LAYER_KHRONOS_validation&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HelloTriangleApplication app;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        app.<span class="built_in">run</span>();</span><br><span class="line">    &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>SwallowJoe
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://swallowjoe.github.io/2022/02/26/Vulkan%E5%85%A5%E9%97%A8-2-%E5%88%9B%E5%BB%BAVulkan%E7%A4%BA%E4%BE%8B%E5%8F%8A%E9%AA%8C%E8%AF%81%E5%B1%82/" title="Vulkan入门(2)-创建Vulkan示例及验证层">https://swallowjoe.github.io/2022/02/26/Vulkan入门-2-创建Vulkan示例及验证层/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/02/26/Vulkan%E5%85%A5%E9%97%A8-1-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" rel="prev" title="Vulkan入门(1)-环境配置">
      <i class="fa fa-chevron-left"></i> Vulkan入门(1)-环境配置
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">1.</span> <span class="nav-text">参考资料</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E8%BF%B0"><span class="nav-number">2.</span> <span class="nav-text">简述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80-%E5%88%9B%E5%BB%BA-vulkan-%E5%AE%9E%E4%BE%8B"><span class="nav-number">3.</span> <span class="nav-text">一. 创建 vulkan 实例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E5%88%9B%E5%BB%BA-Window-%E5%AE%9E%E4%BE%8B"><span class="nav-number">3.1.</span> <span class="nav-text">1.1 创建 Window 实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%88%9B%E5%BB%BA-Vulkan-%E5%AE%9E%E4%BE%8B"><span class="nav-number">3.2.</span> <span class="nav-text">1.2 创建 Vulkan 实例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C-%E9%AA%8C%E8%AF%81%E5%B1%82-Validation-layers"><span class="nav-number">4.</span> <span class="nav-text">二. 验证层(Validation layers)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E4%BB%80%E4%B9%88%E6%98%AF-Validation-layers%EF%BC%9F"><span class="nav-number">4.1.</span> <span class="nav-text">2.1 什么是 Validation layers？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Validation-layers%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.2.</span> <span class="nav-text">2.2 Validation layers示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E5%90%AF%E7%94%A8%E9%AA%8C%E8%AF%81%E5%B1%82"><span class="nav-number">4.3.</span> <span class="nav-text">2.3 启用验证层</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E6%B6%88%E6%81%AF%E5%9B%9E%E8%B0%83"><span class="nav-number">4.4.</span> <span class="nav-text">2.4 消息回调</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-%E8%B0%83%E8%AF%95%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0-debugCallback"><span class="nav-number">4.4.1.</span> <span class="nav-text">2.4.1 调试回调函数 debugCallback</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-%E6%B3%A8%E5%86%8C%E8%B0%83%E8%AF%95%E5%9B%9E%E8%B0%83"><span class="nav-number">4.4.2.</span> <span class="nav-text">2.4.2 注册调试回调</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89-%E4%BB%A3%E7%A0%81"><span class="nav-number">5.</span> <span class="nav-text">三. 代码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-Makefile"><span class="nav-number">5.1.</span> <span class="nav-text">3.1 Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-main-cpp"><span class="nav-number">5.2.</span> <span class="nav-text">3.2 main.cpp</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="SwallowJoe"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">SwallowJoe</p>
  <div class="site-description" itemprop="description">君子知命不惧，日日自新</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/swallowjoe" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;swallowjoe" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SwallowJoe</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
